<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}知识点闪卡 - CPA学习{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cyberpunk.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 闪卡页面特定样式 */
        .flashcard-header {
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
            background: var(--gradient-neon-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subject-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .flashcard-main {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        /* 增强的闪卡样式 */
        .flashcard {
            min-height: 500px;
            margin: 2rem auto;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4rem 3rem;
            overflow-y: auto;
        }

        .flashcard-back {
            transform: rotateY(180deg);
        }

        .card-category {
            position: absolute;
            top: 2rem;
            left: 2rem;
            padding: 0.3rem 0.8rem;
            background: var(--gradient-neon-accent);
            color: var(--bg-primary);
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .card-number {
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 0.3rem 0.8rem;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .flip-hint {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* 控制面板样式 */
        .control-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 900px;
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .difficulty-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-btn.active {
            background: var(--gradient-neon-primary);
            color: var(--bg-primary);
            border-color: transparent;
        }

        /* 进度指示器 */
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .progress-info {
            text-align: center;
        }

        .progress-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--neon-cyan);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .progress-line {
            flex: 1;
            height: 4px;
            background: var(--glass-border);
            border-radius: 2px;
            overflow: hidden;
            max-width: 200px;
        }

        .progress-line-fill {
            height: 100%;
            background: var(--gradient-neon-primary);
            transition: width 0.5s ease;
        }

        /* 知识点标记 */
        .knowledge-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .knowledge-tag {
            padding: 0.3rem 0.8rem;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--neon-cyan);
        }

        /* 学习统计 */
        .study-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            background: var(--gradient-neon-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-name {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .flashcard {
                min-height: 400px;
            }

            .flashcard-front,
            .flashcard-back {
                padding: 2rem 1.5rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .difficulty-selector {
                flex-wrap: wrap;
            }

            .progress-indicator {
                flex-direction: column;
                gap: 1rem;
            }

            .progress-line {
                max-width: 100%;
            }
        }

        /* 加载动画 */
        .card-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
        }

        /* 侧边菜单 */
        .side-menu {
            position: fixed;
            top: 50%;
            right: 2rem;
            transform: translateY(-50%);
            z-index: 100;
        }

        .menu-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .menu-item:hover {
            background: var(--gradient-neon-primary);
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .side-menu {
                bottom: 2rem;
                top: auto;
                right: 50%;
                transform: translateX(50%);
                flex-direction: row;
                display: flex;
            }

            .menu-item {
                margin: 0 0.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <header>
        <nav>
            <div class="glass-container neon-border">
                <a href="{{ url_for('home') }}">
                    <i class="fas fa-home"></i> 首页
                </a>
                <a href="{{ url_for('cpa_learning') }}">
                    <i class="fas fa-graduation-cap"></i> CPA学习
                </a>
                <a href="{{ url_for('flashcards') }}" class="active">
                    <i class="fas fa-clone"></i> 知识闪卡
                </a>
                <a href="{{ url_for('about') }}">
                    <i class="fas fa-info-circle"></i> 关于
                </a>
                {% if session.username %}
                    <a href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt"></i> 注销
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}">
                        <i class="fas fa-sign-in-alt"></i> 登录
                    </a>
                {% endif %}
            </div>
        </nav>
    </header>

    <!-- 消息闪现区域 -->
    <div class="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash-{{ category }} glass-container">
                <div class="flash-message">
                  <span>{{ message }}</span>
                  <button class="flash-close" onclick="this.parentElement.parentElement.style.display='none'">&times;</button>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
    </div>

    <!-- 主要内容 -->
    <main class="main-container page-transition">
        <!-- 页面标题 -->
        <div class="flashcard-header">
            <h1 class="page-title">知识点闪卡</h1>
            <div class="subject-badge">
                <i class="fas fa-book"></i>
                <span id="currentSubject">{{ request.args.get('subject', '会计') or '会计' }}</span>
            </div>
        </div>

        <!-- 进度指示器 -->
        <div class="progress-indicator">
            <div class="progress-info">
                <div class="progress-number" id="currentCard">1</div>
                <div class="progress-label">当前</div>
            </div>
            <div class="progress-line">
                <div class="progress-line-fill" id="progressFill" style="width: 10%"></div>
            </div>
            <div class="progress-info">
                <div class="progress-number" id="totalCards">10</div>
                <div class="progress-label">总计</div>
            </div>
        </div>

        <!-- 闪卡主体 -->
        <div class="flashcard-main">
            <div class="flashcard glass-container neon-border" id="flashcard">
                <!-- 卡片正面 -->
                <div class="flashcard-front">
                    <div class="card-category">会计准则</div>
                    <div class="card-number">1/10</div>

                    <div class="flashcard-content">
                        <div class="flashcard-term neon-text">
                            收入确认原则
                        </div>
                        <div class="knowledge-tags">
                            <span class="knowledge-tag">核心概念</span>
                            <span class="knowledge-tag">必考点</span>
                            <span class="knowledge-tag">⭐⭐⭐</span>
                        </div>
                    </div>

                    <div class="flip-hint">
                        <i class="fas fa-sync-alt"></i>
                        点击翻转查看答案
                    </div>
                </div>

                <!-- 卡片背面 -->
                <div class="flashcard-back">
                    <div class="card-category">详细解释</div>

                    <div class="flashcard-content">
                        <div class="flashcard-definition">
                            <p><strong>收入确认的五步法模型：</strong></p>
                            <ol style="text-align: left; line-height: 1.8;">
                                <li>识别与客户订立的合同</li>
                                <li>识别合同中的单项履约义务</li>
                                <li>确定交易价格</li>
                                <li>将交易价格分摊至各单项履约义务</li>
                                <li>在履行每一单项履约义务时确认收入</li>
                            </ol>
                            <p style="margin-top: 1rem;">
                                <strong>关键要点：</strong>企业应当在履行了合同中的履约义务，即在客户取得相关商品控制权时确认收入。
                            </p>
                        </div>

                        <div class="knowledge-tags">
                            <span class="knowledge-tag">新收入准则</span>
                            <span class="knowledge-tag">IFRS 15</span>
                        </div>
                    </div>

                    <div class="flip-hint">
                        <i class="fas fa-sync-alt"></i>
                        点击翻转返回问题
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <!-- 难度选择 -->
            <div class="difficulty-selector">
                <button class="difficulty-btn active" onclick="setDifficulty('all')">全部</button>
                <button class="difficulty-btn" onclick="setDifficulty('easy')">简单</button>
                <button class="difficulty-btn" onclick="setDifficulty('medium')">中等</button>
                <button class="difficulty-btn" onclick="setDifficulty('hard')">困难</button>
            </div>

            <!-- 控制按钮 -->
            <div class="flashcard-controls">
                <button class="btn btn-glass" onclick="previousCard()">
                    <i class="fas fa-chevron-left"></i> 上一张
                </button>
                <button class="btn btn-neon" onclick="flipCard()">
                    <i class="fas fa-sync-alt"></i> 翻转
                </button>
                <button class="btn btn-glass" onclick="nextCard()">
                    下一张 <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- 学习统计 -->
            <div class="study-stats">
                <div class="stat-item">
                    <div class="stat-value">24</div>
                    <div class="stat-name">已学习</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">18</div>
                    <div class="stat-name">已掌握</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">6</div>
                    <div class="stat-name">需复习</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">85%</div>
                    <div class="stat-name">正确率</div>
                </div>
            </div>
        </div>

        <!-- 快速操作按钮 -->
        <div class="button-group">
            <button class="btn btn-glass" onclick="shuffleCards()">
                <i class="fas fa-random"></i> 随机顺序
            </button>
            <button class="btn btn-glass" onclick="startPractice()">
                <i class="fas fa-play"></i> 开始练习
            </button>
            <button class="btn btn-neon" onclick="goToLearning()">
                <i class="fas fa-arrow-left"></i> 返回学习
            </button>
        </div>
    </main>

    <!-- 侧边菜单 -->
    <div class="side-menu">
        <div class="menu-item" onclick="toggleStar()" title="收藏">
            <i class="fas fa-star"></i>
        </div>
        <div class="menu-item" onclick="markDifficult()" title="标记困难">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="menu-item" onclick="addNote()" title="添加笔记">
            <i class="fas fa-sticky-note"></i>
        </div>
        <div class="menu-item" onclick="shareCard()" title="分享">
            <i class="fas fa-share-alt"></i>
        </div>
    </div>

    <script>
        // 闪卡数据
        const flashcardsData = {
            accounting: [
                {
                    id: 1,
                    category: "会计准则",
                    term: "收入确认原则",
                    definition: "收入确认的五步法模型：1.识别与客户订立的合同 2.识别合同中的单项履约义务 3.确定交易价格 4.将交易价格分摊至各单项履约义务 5.在履行每一单项履约义务时确认收入",
                    tags: ["核心概念", "必考点", "⭐⭐⭐"],
                    difficulty: "hard"
                },
                {
                    id: 2,
                    category: "资产计量",
                    term: "存货计价方法",
                    definition: "存货计价方法包括：先进先出法(FIFO)、后进先出法(LIFO)、加权平均法、个别计价法。中国企业会计准则规定不允许采用后进先出法。",
                    tags: ["基础概念", "⭐⭐"],
                    difficulty: "medium"
                },
                {
                    id: 3,
                    category: "财务报表",
                    term: "现金流量表分类",
                    definition: "现金流量表分为三类活动：1.经营活动现金流量 2.投资活动现金流量 3.筹资活动现金流量",
                    tags: ["重要考点", "⭐⭐⭐"],
                    difficulty: "easy"
                }
            ],
            audit: [
                {
                    id: 1,
                    category: "审计概念",
                    term: "审计证据充分性",
                    definition: "审计证据的充分性是指审计证据的数量足以支持审计结论。影响充分性的因素：重要性水平、审计风险、内部控制质量等。",
                    tags: ["核心概念", "⭐⭐⭐"],
                    difficulty: "hard"
                }
            ]
        };

        let currentCardIndex = 0;
        let currentSubject = '{{ request.args.get("subject", "accounting") }}' || 'accounting';
        let currentDifficulty = 'all';
        let currentCards = [];
        let isFlipped = false;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCards();
            updateCard();

            // 添加键盘事件
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') previousCard();
                if (e.key === 'ArrowRight') nextCard();
                if (e.key === ' ') {
                    e.preventDefault();
                    flipCard();
                }
            });

            // 添加触摸手势支持
            addTouchSupport();
        });

        function loadCards() {
            const allCards = flashcardsData[currentSubject] || flashcardsData.accounting;
            currentCards = currentDifficulty === 'all'
                ? allCards
                : allCards.filter(card => card.difficulty === currentDifficulty);

            document.getElementById('totalCards').textContent = currentCards.length;
        }

        function updateCard() {
            if (currentCards.length === 0) return;

            const card = currentCards[currentCardIndex];
            const flashcardElement = document.getElementById('flashcard');

            // 重置翻转状态
            flashcardElement.classList.remove('flipped');
            isFlipped = false;

            // 更新卡片内容
            const frontContent = flashcardElement.querySelector('.flashcard-front');
            const backContent = flashcardElement.querySelector('.flashcard-back');

            frontContent.querySelector('.card-category').textContent = card.category;
            frontContent.querySelector('.card-number').textContent = `${currentCardIndex + 1}/${currentCards.length}`;
            frontContent.querySelector('.flashcard-term').textContent = card.term;

            // 更新标签
            const tagsHtml = card.tags.map(tag => `<span class="knowledge-tag">${tag}</span>`).join('');
            frontContent.querySelector('.knowledge-tags').innerHTML = tagsHtml;

            backContent.querySelector('.card-category').textContent = '详细解释';
            backContent.querySelector('.flashcard-definition').innerHTML = `<p>${card.definition}</p>`;

            // 更新进度
            updateProgress();
        }

        function updateProgress() {
            const progress = ((currentCardIndex + 1) / currentCards.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('currentCard').textContent = currentCardIndex + 1;
        }

        function flipCard() {
            const flashcardElement = document.getElementById('flashcard');
            flashcardElement.classList.toggle('flipped');
            isFlipped = !isFlipped;

            // 添加翻转音效（可选）
            playSound('flip');
        }

        function nextCard() {
            if (currentCardIndex < currentCards.length - 1) {
                currentCardIndex++;
                updateCard();
                animateCardTransition('next');
            } else {
                // 到达最后一张卡片
                showCompletionMessage();
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCard();
                animateCardTransition('prev');
            }
        }

        function animateCardTransition(direction) {
            const flashcard = document.getElementById('flashcard');
            flashcard.style.opacity = '0';
            flashcard.style.transform = direction === 'next' ? 'translateX(50px)' : 'translateX(-50px)';

            setTimeout(() => {
                flashcard.style.transition = 'all 0.3s ease';
                flashcard.style.opacity = '1';
                flashcard.style.transform = 'translateX(0)';
            }, 100);
        }

        function setDifficulty(difficulty) {
            currentDifficulty = difficulty;

            // 更新按钮状态
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 重新加载卡片
            currentCardIndex = 0;
            loadCards();
            updateCard();
        }

        function shuffleCards() {
            for (let i = currentCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentCards[i], currentCards[j]] = [currentCards[j], currentCards[i]];
            }
            currentCardIndex = 0;
            updateCard();

            // 显示提示
            showNotification('卡片顺序已随机打乱', 'success');
        }

        function startPractice() {
            showNotification('练习模式即将开始', 'info');
            // 可以实现练习模式的逻辑
        }

        function goToLearning() {
            window.location.href = '{{ url_for("cpa_learning") }}';
        }

        // 侧边菜单功能
        function toggleStar() {
            event.currentTarget.classList.toggle('active');
            const isActive = event.currentTarget.classList.contains('active');
            showNotification(isActive ? '已添加到收藏' : '已取消收藏', 'success');
        }

        function markDifficult() {
            event.currentTarget.classList.toggle('active');
            const isActive = event.currentTarget.classList.contains('active');
            showNotification(isActive ? '已标记为困难' : '已取消困难标记', 'info');
        }

        function addNote() {
            const note = prompt('请输入笔记内容：');
            if (note) {
                showNotification('笔记已保存', 'success');
            }
        }

        function shareCard() {
            if (navigator.share) {
                navigator.share({
                    title: 'CPA知识点闪卡',
                    text: `${currentCards[currentCardIndex].term} - ${currentCards[currentCardIndex].definition.substring(0, 50)}...`,
                    url: window.location.href
                });
            } else {
                showNotification('分享链接已复制到剪贴板', 'success');
            }
        }

        // 触摸手势支持
        function addTouchSupport() {
            const flashcard = document.getElementById('flashcard');
            let touchStartX = 0;
            let touchEndX = 0;

            flashcard.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            });

            flashcard.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchEndX - touchStartX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        previousCard();
                    } else {
                        nextCard();
                    }
                }
            }
        }

        // 音效支持（可选）
        function playSound(type) {
            // 可以添加音效
            // const audio = new Audio(`/static/sounds/${type}.mp3`);
            // audio.play().catch(e => console.log('音效播放失败:', e));
        }

        // 通知系统
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `flash-${type} glass-container`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                min-width: 200px;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `
                <div class="flash-message">
                    <span>${message}</span>
                    <button class="flash-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showCompletionMessage() {
            showNotification('恭喜！您已完成本轮学习', 'success');
            setTimeout(() => {
                if (confirm('是否重新开始学习？')) {
                    currentCardIndex = 0;
                    updateCard();
                }
            }, 1000);
        }

        // 更新当前科目显示
        document.getElementById('currentSubject').textContent = {
            'accounting': '会计',
            'audit': '审计',
            'finance': '财务成本管理',
            'law': '经济法'
        }[currentSubject] || '会计';
    </script>
</body>
</html>